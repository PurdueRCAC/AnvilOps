generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  runtime                = "nodejs"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                      @id @default(autoincrement())
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  email             String?                  @unique
  name              String?
  githubAccessToken String?
  ciLogonUserId     String?                  @unique
  orgs              OrganizationMembership[]
}

model OrganizationMembership {
  userId          Int
  user            User            @relation(fields: [userId], references: [id])
  organizationId  Int
  organization    Organization    @relation(fields: [organizationId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  permissionLevel PermissionLevel

  @@id([userId, organizationId])
}

enum PermissionLevel {
  OWNER
  USER
}

model Organization {
  id         Int                      @id @default(autoincrement())
  createdAt  DateTime                 @default(now())
  updatedAt  DateTime                 @updatedAt
  name       String
  users      OrganizationMembership[]
  apps       App[]
}

model App {
  id             Int          @id @default(autoincrement())
  orgId          Int
  org            Organization @relation(fields: [orgId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  name           String
  repositoryURL  String
  webhookSecret  String
  dockerfilePath String
  port           Int
}

model Session {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], name: "IDX_session_expire")
  @@map("session")
}