openapi: 3.1.0
servers:
  - url: /api
info:
  title: AnvilOps API
  description: ""
  version: 0.0.1
tags:
  - name: user
    description: Operations about users
  - name: org
    description: Operations about organizations
  - name: app
    description: Operations about apps
paths:
  /login:
    get:
      tags:
        - user
      description: Log in user
      operationId: auth_loginUser
      responses:
        "302":
          description: Redirect to identity provider
          headers:
            Location:
              content:
                text/plain:
                  schema:
                    type: string
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /oauth_callback:
    get:
      tags:
        - user
      description: Handle callback
      operationId: auth_handleCallback
      responses:
        "302":
          description: Redirect to application
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /logout:
    post:
      tags:
        - user
      description: Logs out current user
      operationId: auth_logoutUser
      responses:
        "200":
          description: Success
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/installation-callback:
    get:
      description: GitHub installation callback URL. Users are redirected here after they install the app. Then, we redrect them back to GitHub to generate a user access token to verify that they have access to the installation that they're requesting to link with their organization.
      operationId: githubInstallCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: installation_id
          in: query
          description: An identifier that allows us to authenticate with the GitHub API as our GitHub App and access the repositories that the person who installed the app has granted us access to.
          required: true
          schema:
            type: integer
            format: int64
        - name: setup_action
          in: query
          description: Should be set to "install".
          schema:
            type: string
      responses:
        "302":
          description: Success (redirecting back to GitHub for user authorization)
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the installation flow)
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/oauth2-callback:
    get:
      description: GitHub user authorization callback URL. Users are redirected here after they sign in with GitHub. This endpoint checks that they have access to the installation ID that they're trying to link to their organization and then saves that info in our DB.
      operationId: githubOAuthCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: code
          in: query
          description: A code that we exchange with GitHub for a user access token.
          required: true
          schema:
            type: string
      responses:
        "302":
          description: Success (redirecting back to the frontend)
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the authorization flow)
        "403":
          description: Forbidden (invalid state or code)
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/webhook:
    post:
      description: GitHub App webhooks (see https://docs.github.com/en/apps/creating-github-apps/writing-code-for-a-github-app/building-a-github-app-that-responds-to-webhook-events) for more info
      operationId: githubWebhook
      parameters:
        # Taken from https://raw.githubusercontent.com/github/rest-api-description/refs/heads/main/descriptions/ghes-3.16/ghes-3.16.yaml under /x-webhooks/push/post/parameters
        - name: User-Agent
          in: header
          example: GitHub-Hookshot/123abc
          schema:
            type: string
        - name: X-Github-Hook-Id
          in: header
          example: 12312312
          schema:
            type: string
        - name: X-Github-Event
          in: header
          example: issues
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Id
          in: header
          example: 123123
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Type
          in: header
          example: repository
          schema:
            type: string
        - name: X-GitHub-Delivery
          in: header
          example: 0b989ba4-242f-11e5-81e1-c7b6966d2516
          schema:
            type: string
        - name: X-Hub-Signature-256
          in: header
          example: sha256=6dcb09b5b57875f334f61aebed695e2e4193db5e
          schema:
            type: string
        - name: X-GitHub-Enterprise-Version
          in: header
          example: 3.1.9
          schema:
            type: string
        - name: X-GitHub-Enterprise-Host
          in: header
          example: ghes.github.com
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-push"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-created"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-deleted"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-renamed"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-transferred"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-deleted"
      responses:
        "200":
          description: Success
        "401":
          description: Signature was not found (X-Hub-Signature-256 header not present)
        "403":
          description: Signature verification failed
        "422":
          description: Unknown webhook event type
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /user/me:
    get:
      tags:
        - user
      description: Returns the current user
      operationId: getUser
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - user
      description: Deletes the current user.
      operationId: deleteUser
      # parameters:
      #   - name: access_token
      #     in: header
      #     required: true
      #     schema:
      #       type: string
      responses:
        "200":
          description: User deleted
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /user/joinOrg:
    post:
      tags:
        - user
      description: Adds the current user to an organization
      operationId: joinOrg
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                inviteCode:
                  type: string
              required:
                - inviteCode
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserOrg"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /org:
    post:
      tags:
        - org
      description: Create an organization
      operationId: createOrg
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
                - name
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserOrg"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get organization by id
      operationId: getOrgByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - org
      description: Deletes organization by id
      operationId: deleteOrgByID
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/install-github-app:
    get:
      description: Redirect to GitHub to install the GitHub App on the user's organization
      operationId: githubAppInstall
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "302":
          description: Redirect
        "401":
          description: Unauthorized
        "404":
          description: Organization not found
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/import-repo/create-state:
    post:
      description: Creates a state ID that can be used with /org/{orgId}/import-repo. It's done this way because, to create a repo on a user account, we need to authorize with GitHub. To import a repo, call this endpoint to get a state ID. Then, redirect to the URL present in the response.
      operationId: importGitRepoCreateState
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sourceURL:
                  type: string
                  format: uri
                destOwner:
                  type: string
                destIsOrg:
                  type: boolean
                destRepo:
                  type: string
                makePrivate:
                  type: boolean
              required:
                - sourceURL
                - destOwner
                - destIsOrg
                - destRepo
                - makePrivate

      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                required: [url]
        "308":
          description: Redirect to Import Repo endpoint (copying the Git repository immediately without needing permission grant from user)
        "400":
          description: GitHub App not installed
        "404":
          description: Organization not found
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /import-repo:
    post:
      description: Copies a Git repository from another account or server to the user's (or their organization's) GitHub account
      operationId: importGitRepo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                code:
                  type: string
              required:
                - state

      responses:
        "201":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  orgId:
                    description: AnvilOps organization ID that has access to the imported repository. Present if the repo was created successfully
                    type: number
                    format: int64
                  repoId:
                    description: Present if the repo was created successfully
                    type: number
                    format: int64
                  url:
                    description: Present if creating from a template failed and the user needs to authorize
                    type: string
                    format: uri
        "400":
          description: GitHub App not installed or other validation error
        "404":
          description: Organization not found
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/installation:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get GitHub App installation information for an organization
      operationId: getInstallation
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  targetId:
                    type: number
                    description: ID of the user or organization that the app is installed on
                  targetType:
                    type: string
                    enum: [User, Organization]
                  targetName:
                    type: string
                    description: The name of the user or organization that the app is installed on
                  hasAllRepoAccess:
                    type: boolean
                    description: Whether the app has access to all repositories on the target user or organization
                required: [targetId, targetType, targetName, hasAllRepoAccess]
        "401":
          description: Unauthorized
        "404":
          description: Not Found (GitHub App not installed or organization not found)
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/code:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get invite code for org
      operationId: getInviteCodeByID
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/repos:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: Get the Git repositories that the organization has access to
      operationId: listOrgRepos
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    name:
                      type: string
                    owner:
                      type: string

  /org/{orgId}/repos/{repoId}/branches:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
      - name: repoId
        in: path
        description: GitHub repository ID
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: List the Git branches of a repository
      operationId: listRepoBranches
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  default:
                    type: string
                  branches:
                    type: array
                    items:
                      type: string

  /app:
    post:
      tags:
        - app
      description: Create an app.
      operationId: createApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewApp"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: number
                    format: int64
                    description: The ID of the newly-created app
        "302":
          description: Redirecting to finish GitHub App installation
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: Contact owner to complete GitHub App installation
        "409":
          description: Subdomain is taken
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/{appId}:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - app
      description: Get app detail by id.
      operationId: getAppByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    put:
      tags:
        - app
      description: Update the configuration of an app.
      operationId: updateApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppUpdate"
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "400":
          description: Malformed app
        "409":
          description: No image available to redeploy because app has never built successfully
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - app
      description: Delete an app.
      operationId: deleteApp
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /app/{appId}/status:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: List an app's running pods and their statuses
      operationId: getAppStatus
      responses:
        "404":
          description: App not found
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  pods:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        createdAt:
                          type: string
                        startedAt:
                          type: string
                        deploymentId:
                          type: number
                          format: int64
                        node:
                          type: string
                        podScheduled:
                          type: boolean
                        podReady:
                          type: boolean
                        image:
                          type: string
                        containerReady:
                          type: boolean
                        containerState:
                          $ref: "#/components/schemas/ContainerState"
                        lastState:
                          $ref: "#/components/schemas/ContainerState"
                        ip:
                          type: string
                  statefulSet:
                    type: object
                    properties:
                      readyReplicas:
                        type: number
                      updatedReplicas:
                        type: number
                      replicas:
                        type: number
                      generation:
                        type: number
                      observedGeneration:
                        type: number
                      currentRevision:
                        type: string
                      updateRevision:
                        type: string
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        message:
                          type: string
                        reason:
                          type: string
                        count:
                          type: number
                        firstTimestamp:
                          type: string
                          format: date-time
                        lastTimestamp:
                          type: string
                          format: date-time

  /app/{appId}/deployments:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: List an app's recent deployments
      operationId: listDeployments
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    appId:
                      type: number
                      format: int64
                    commitHash:
                      type: string
                    commitMessage:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
                    status:
                      $ref: "#/components/schemas/DeploymentStatus"
                    source:
                      type: string
                      enum: [GIT, IMAGE]
                    imageTag:
                      type: string
                      nullable: true
                  required:
                    - id
                    - appId
                    - commitHash
                    - commitMessage
                    - createdAt
                    - updatedAt
                    - status
                    - source
                    - imageTag

  /app/{appId}/deployments/{deploymentId}/logs:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's recent logs
      operationId: getAppLogs
      parameters:
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/LogType"
      responses:
        "404":
          description: App not found
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        time:
                          type: string
                          format: date-time
                        log:
                          type: string
                        type:
                          $ref: "#/components/schemas/LogType"
                        id:
                          type: number
                          format: int64
                required: [logs]

  /logs/ingest:
    post:
      operationId: ingestLogs
      parameters:
        - name: type
          in: query
          required: true
          schema:
            type: string
            enum: [build, runtime]
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: appId
          in: query
          schema:
            type: number
            format: int64
      requestBody:
        content:
          application/jsonl: # jsonl = newline-delimited JSON objects (https://jsonlines.org/)
            schema:
              type: string
      responses:
        "200":
          description: Success
        "400":
          description: Bad request (no app ID specified when it was required)
        "403":
          description: Invalid credentials
        "422":
          description: Unexpected authentication type (expected Basic) or log type (expected build or runtime)
        "500":
          description: Internal server error

  /app/{appId}/deployments/{deploymentId}:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's deployment by its ID
      operationId: getDeployment
      responses:
        "404":
          description: Deployment not found
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: number
                    format: int64
                  appId:
                    type: number
                    format: int64
                  commitHash:
                    type: string
                  commitMessage:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time
                  status:
                    $ref: "#/components/schemas/DeploymentStatus"
                  config:
                    $ref: "#/components/schemas/DeploymentConfig"
                  podStatus:
                    type: object
                    properties:
                      scheduled:
                        type: number
                      ready:
                        type: number
                      total:
                        type: number
                      failed:
                        type: number
                    required: [scheduled, ready, total, failed]
                required:
                  - id
                  - appId
                  - commitHash
                  - commitMessage
                  - createdAt
                  - updatedAt
                  - status
                  - config

  /app/subdomain:
    description: Checks if a subdomain is available for use.
    get:
      operationId: isSubdomainAvailable
      parameters:
        - name: subdomain
          in: query
          description: The subdomain to check.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                required: [available]
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /deployment/update:
    description: Updates a deployment's status. Meant to be called from a build job.
    post:
      operationId: updateDeployment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                secret:
                  type: string
                status:
                  type: string
      responses:
        "200":
          description: Success
        "400":
          description: Bad request
        "401":
          description: No secret provided
        "403":
          description: Invalid secret
components:
  schemas:
    UserOrg:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        permissionLevel:
          type: string
          enum: [OWNER, USER]
        githubConnected:
          type: boolean
      required:
        - id
        - name
        - permissionLevel
        - githubConnected
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        name:
          type: string
        orgs:
          type: array
          items:
            $ref: "#/components/schemas/UserOrg"
      required:
        - id
        - email
        - name
        - orgs

    Org:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        members:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              name:
                type: string
              email:
                type: string
                format: email
              permissionLevel:
                type: string
                enum: [OWNER, USER]
            required: [id, name, email, permissionLevel]
        apps:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              displayName:
                type: string
              status:
                type: string
                enum: [PENDING, BUILDING, DEPLOYING, COMPLETE, ERROR, STOPPED]
              source:
                type: string
                enum: [GIT, IMAGE]
              imageTag:
                type: string
                nullable: true
              repositoryURL:
                type: string
                format: uri
                nullable: true
              branch:
                type: string
                nullable: true
              commitHash:
                type: string
                nullable: true
              link:
                type: string
                format: uri
            required:
              - id
              - displayName
              - status
              - source
              - imageTag
              - repositoryURL
              - branch
              - commitHash
              - link

        githubInstallationId:
          type: integer
          format: int64
      required:
        - id
        - name
        - members
        - apps
    App:
      type: object
      properties:
        id:
          type: integer
          format: int64
        orgId:
          type: integer
          format: int64
        createdAt:
          type: string
        updatedAt:
          type: string
        displayName:
          type: string
        repositoryId:
          type: number
          format: int64
        repositoryURL:
          type: string
        config:
          $ref: "#/components/schemas/DeploymentConfig"
        subdomain:
          type: string
        activeDeployment:
          type: number
          format: int64
      required:
        - id
        - orgId
        - createdAt
        - updatedAt
        - displayName
        - config
        - subdomain
        - activeDeployment
    AppUpdate:
      type: object
      properties:
        name:
          type: string
        config:
          $ref: "#/components/schemas/DeploymentConfig"
      required:
        - name
        - config
    DeploymentConfig:
      type: object
      properties:
        # Source options
        source:
          type: string
          enum: ["image", "git"]
        # Source options > Git repository
        dockerfilePath:
          type: string
          nullable: true
          description: Required when source == "git"
        rootDir:
          type: string
          nullable: true
          description: Required when source == "git"
        repositoryId:
          type: integer
          format: int64
          nullable: true
          description: Required when source == "git"
        branch:
          type: string
          nullable: true
          description: Required when source == "git"
        builder:
          type: string
          nullable: true
          description: Required when source == "git"
          enum: [dockerfile, railpack, null]
        # Source options > OCI image
        imageTag:
          type: string
          nullable: true
          description: Required when source == "image"
        # Deployment options
        port:
          type: integer
          format: int64
        replicas:
          type: integer
          format: int64
        env:
          $ref: "#/components/schemas/Envs"
        mounts:
          type: array
          items:
            $ref: "#/components/schemas/Mount"
      required:
        - source
        - imageTag
        - port
        - dockerfilePath
        - rootDir
        - branch
        - builder
        - replicas
        - mounts
        - env
    Mount:
      type: object
      properties:
        path:
          type: string
        amountInMiB:
          type: integer
      required: [path, amountInMiB]
    DeploymentStatus:
      type: string
      enum: [PENDING, BUILDING, DEPLOYING, COMPLETE, ERROR, STOPPED]
    LogType:
      type: string
      enum: [SYSTEM, BUILD, RUNTIME]
    NewApp:
      type: object
      properties:
        name:
          type: string
        # Source options
        orgId:
          type: integer
          format: int64
        source:
          type: string
          enum: [git, image]
        # Source options > Git repository
        repositoryId:
          type: number
          nullable: true
          format: int64
        dockerfilePath:
          type: string
          nullable: true
        rootDir:
          type: string
          nullable: true
        branch:
          type: string
          nullable: true
        builder:
          type: string
          nullable: true
          enum: [dockerfile, railpack, null]
        # Source options > OCI image
        imageTag:
          type: string
          nullable: true
        # Deployment options
        subdomain:
          type: string
          format: hostname
        port:
          type: integer
          format: int64
        env:
          $ref: "#/components/schemas/Envs"
        mounts:
          type: array
          items:
            $ref: "#/components/schemas/Mount"
      required:
        - orgId
        - source
        - name
        - repositoryId
        - dockerfilePath
        - subdomain
        - port
        - rootDir
        - branch
        - builder
        - mounts
        - imageTag
        - env
    NewEnvs:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
          value:
            type: string
          isSensitive:
            type: boolean
        required: [name, value, isSensitive]
    Envs:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
          value:
            type: string
            nullable: true
          isSensitive:
            type: boolean
        required: [name, value, isSensitive]
    ApiError:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      required:
        - code
        - message
    ContainerState:
      oneOf:
        - type: object
          properties:
            running:
              type: object
              properties:
                startedAt:
                  type: string
                  format: date-time
        - type: object
          properties:
            terminated:
              type: object
              properties:
                containerID:
                  type: string
                exitCode:
                  type: number
                finishedAt:
                  type: string
                  format: date-time
                message:
                  type: string
                reason:
                  type: string
                signal:
                  type: number
                startedAt:
                  type: string
        - type: object
          properties:
            waiting:
              type: object
              properties:
                message:
                  type: string
                reason:
                  type: string
