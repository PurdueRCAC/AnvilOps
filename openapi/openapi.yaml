openapi: 3.0.3
servers:
  - url: /api
info:
  title: AnvilOps API
  description: ""
  version: 0.0.1
tags:
  - name: user
    description: Operations about users
  - name: org
    description: Operations about organizations
  - name: app
    description: Operations about apps
paths:
  /liveness:
    get:
      operationId: livenessProbe
      description: Liveness probe
      responses:
        "200":
          description: Success
  /settings:
    get:
      description: Get AnvilOps configuration
      operationId: getSettings
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  appDomain:
                    type: string
                    format: uri
                  clusterName:
                    type: string
                  faq:
                    type: object
                    properties:
                      question:
                        type: string
                      answer:
                        type: string
                      link:
                        type: string
                  storageEnabled:
                    type: boolean
                  isRancherManaged:
                    type: boolean
  /login:
    get:
      tags:
        - user
      description: Log in user
      operationId: auth_loginUser
      responses:
        "302":
          description: Redirect to identity provider
          headers:
            Location:
              content:
                text/plain:
                  schema:
                    type: string
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /oauth_callback:
    get:
      tags:
        - user
      description: Handle callback
      operationId: auth_handleCallback
      responses:
        "302":
          description: Redirect to application
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /logout:
    post:
      tags:
        - user
      description: Logs out current user
      operationId: auth_logoutUser
      responses:
        "200":
          description: Success
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/installation-callback:
    get:
      description: GitHub installation callback URL. Users are redirected here after they install the app. Then, we redrect them back to GitHub to generate a user access token to verify that they have access to the installation that they're requesting to link with their organization.
      operationId: githubInstallCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: installation_id
          in: query
          description: An identifier that allows us to authenticate with the GitHub API as our GitHub App and access the repositories that the person who installed the app has granted us access to.
          schema:
            type: integer
            format: int64
        - name: setup_action
          in: query
          description: Should be set to "install", "update", or "request". If set to "install" or "update", the app will be linked to an AnvilOps organization immediately. If not, the user will see a popup in their dashboard when the request is approved, which they'll use to link the installation to an AnvilOps organization.
          schema:
            type: string
            enum: [install, update, request]
      responses:
        "302":
          description: Success (redirecting back to GitHub for user authorization)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the installation flow)
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/oauth2-callback:
    get:
      description: GitHub user authorization callback URL. Users are redirected here after they sign in with GitHub. This endpoint checks that they have access to the installation ID that they're trying to link to their organization and then saves that info in our DB.
      operationId: githubOAuthCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: code
          in: query
          description: A code that we exchange with GitHub for a user access token.
          required: true
          schema:
            type: string
      responses:
        "302":
          description: Success (redirecting back to the frontend)
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the authorization flow)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Forbidden (invalid state or code)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/webhook:
    post:
      description: GitHub App webhooks (see https://docs.github.com/en/apps/creating-github-apps/writing-code-for-a-github-app/building-a-github-app-that-responds-to-webhook-events) for more info
      operationId: githubWebhook
      parameters:
        # Taken from https://raw.githubusercontent.com/github/rest-api-description/refs/heads/main/descriptions/ghes-3.16/ghes-3.16.yaml under /x-webhooks/push/post/parameters
        - name: User-Agent
          in: header
          example: GitHub-Hookshot/123abc
          schema:
            type: string
        - name: X-Github-Hook-Id
          in: header
          example: 12312312
          schema:
            type: string
        - name: X-Github-Event
          in: header
          example: issues
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Id
          in: header
          example: 123123
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Type
          in: header
          example: repository
          schema:
            type: string
        - name: X-GitHub-Delivery
          in: header
          example: 0b989ba4-242f-11e5-81e1-c7b6966d2516
          schema:
            type: string
        - name: X-Hub-Signature-256
          in: header
          example: sha256=6dcb09b5b57875f334f61aebed695e2e4193db5e
          schema:
            type: string
        - name: X-GitHub-Enterprise-Version
          in: header
          example: 3.1.9
          schema:
            type: string
        - name: X-GitHub-Enterprise-Host
          in: header
          example: ghes.github.com
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-workflow-run"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-push"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-created"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-deleted"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-renamed"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-transferred"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-deleted"
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Signature was not found (X-Hub-Signature-256 header not present)
        "403":
          description: Signature verification failed
        "422":
          description: Unknown webhook event type
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /user/me:
    get:
      tags:
        - user
      description: Returns the current user
      operationId: getUser
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org:
    post:
      tags:
        - org
      description: Create an organization
      operationId: createOrg
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
                - name
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserOrg"
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get organization by id
      operationId: getOrgByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - org
      description: Deletes organization by id
      operationId: deleteOrgByID
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/claim:
    post:
      description: Connects an AnvilOps organization to a GitHub organization from a request that had been approved in the background.
      operationId: claimOrg
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                unclaimedInstallationId:
                  description: The ID of the unclaimed installation. This is the ID of the unclaimed installation record in the database, not the GitHub installation ID!
                  type: integer
                  format: int64
              required: [unclaimedInstallationId]
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Internal server error

  /org/{orgId}/invitation:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: integer
    post:
      description: Invites a user to the organization
      operationId: inviteUser
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
              required: [email]
      responses:
        "201":
          description: Success (invitation created)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Other user or target organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/invitation/{invId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: integer
      - name: invId
        in: path
        required: true
        schema:
          type: integer
    delete:
      description: Revokes an invitation
      operationId: revokeInvitation
      responses:
        "204":
          description: Success (invitation revoked/deleted)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Organization or invitation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/invitation/{invId}/accept:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: integer
      - name: invId
        in: path
        required: true
        schema:
          type: integer
    post:
      description: Accepts an invitation
      operationId: acceptInvitation
      responses:
        "200":
          description: Success (invitation accepted)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/user/{userId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: integer
      - name: userId
        in: path
        required: true
        schema:
          type: integer
    delete:
      description: Removes a user from an organization
      operationId: removeUserFromOrg
      responses:
        "204":
          description: Success (user removed)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Forbidden (caller is a member of the organization but doesn't have permission to remove members)
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/install-github-app:
    get:
      description: Redirect to GitHub to install the GitHub App on the user's organization
      operationId: githubAppInstall
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "302":
          description: Redirect
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/import-repo/create-state:
    post:
      description: Creates a state ID that can be used with /org/{orgId}/import-repo. It's done this way because, to create a repo on a user account, we need to authorize with GitHub. To import a repo, call this endpoint to get a state ID. Then, redirect to the URL present in the response.
      operationId: importGitRepoCreateState
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sourceURL:
                  type: string
                  format: uri
                destOwner:
                  type: string
                destIsOrg:
                  type: boolean
                destRepo:
                  type: string
                makePrivate:
                  type: boolean
              required:
                - sourceURL
                - destOwner
                - destIsOrg
                - destRepo
                - makePrivate

      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                required: [url]
        "308":
          description: Redirect to Import Repo endpoint (copying the Git repository immediately without needing permission grant from user)
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: GitHub App not installed
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /import-repo:
    post:
      description: Copies a Git repository from another account or server to the user's (or their organization's) GitHub account
      operationId: importGitRepo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                code:
                  type: string
              required:
                - state

      responses:
        "201":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  orgId:
                    description: AnvilOps organization ID that has access to the imported repository. Present if the repo was created successfully
                    type: number
                    format: int64
                  repoId:
                    description: Present if the repo was created successfully
                    type: number
                    format: int64
                  url:
                    description: Present if creating from a template failed and the user needs to authorize
                    type: string
                    format: uri
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/installation:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get GitHub App installation information for an organization
      operationId: getInstallation
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  targetId:
                    type: number
                    description: ID of the user or organization that the app is installed on
                  targetType:
                    type: string
                    enum: [User, Organization]
                  targetName:
                    type: string
                    description: The name of the user or organization that the app is installed on
                  hasAllRepoAccess:
                    type: boolean
                    description: Whether the app has access to all repositories on the target user or organization
                required: [targetId, targetType, targetName, hasAllRepoAccess]
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found (GitHub App not installed or organization not found)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/repos:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: Get the Git repositories that the organization has access to
      operationId: listOrgRepos
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    name:
                      type: string
                    owner:
                      type: string
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: GitHub app not installed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/repos/{repoId}/branches:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
      - name: repoId
        in: path
        description: GitHub repository ID
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: List the Git branches of a repository
      operationId: listRepoBranches
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  default:
                    type: string
                  branches:
                    type: array
                    items:
                      type: string
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: GitHub app not installed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/repos/{repoId}/workflows:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
      - name: repoId
        in: path
        description: GitHub repository ID
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: List the GitHub workflows for a repository
      operationId: listRepoWorkflows
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflows:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          format: int64
                        name:
                          type: string
                        path:
                          type: string
                      required: [id, name, path]
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: GitHub app not installed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/groups:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: List the ids, names, and Rancher projects of app groups belonging to the organization to which apps can be added
      operationId: listOrgGroups
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    name:
                      type: string
                  required: [id, name]
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app:
    post:
      tags:
        - app
      description: Create an app.
      operationId: createApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewApp"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: number
                    format: int64
                    description: The ID of the newly-created app
        "302":
          description: Redirecting to finish GitHub App installation
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: Contact owner to complete GitHub App installation
        "409":
          description: Subdomain is taken
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/group:
    post:
      tags: [app]
      description: Create a group of apps.
      operationId: createAppGroup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                orgId:
                  type: integer
                  format: int64
                apps:
                  type: array
                  items:
                    $ref: "#/components/schemas/NewAppWithoutGroupInfo"
              required:
                - name
                - orgId
                - apps
      responses:
        "200":
          description: Success
        "302":
          description: Redirecting to finish GitHub App installation
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: Contact owner to complete GitHub App installation
        "409":
          description: Subdomain is taken
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/{appId}:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - app
      description: Get app detail by id.
      operationId: getAppByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    put:
      tags:
        - app
      description: Update the configuration of an app.
      operationId: updateApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppUpdate"
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/{appId}/delete:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    post:
      tags:
        - app
      description: Delete an app.
      operationId: deleteApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                keepNamespace:
                  type: boolean
              required: [keepNamespace]
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /app/{appId}/cd:
    parameters:
      - name: appId
        in: path
        description: Id of app
        required: true
        schema:
          type: integer
          format: int64
    put:
      tags:
        - app
      description: Enable or disable continuous deployment for an app.
      operationId: setAppCD
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enable:
                  type: boolean
              required: [enable]
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /app/{appId}/status:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: List an app's running pods and their statuses
      operationId: getAppStatus
      responses:
        "200":
          description: Success
          content:
            text/event-stream:
              schema:
                type: string
                description: A server-sent events (SSE) response. When the state changes, a new object will be pushed onto the stream with the new state. Each event will follow the schema of '#/components/schemas/AppStatus'.
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: App not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/{appId}/pods/{podName}:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: podName
        in: path
        required: true
        schema:
          type: string
    delete:
      tags: [app]
      description: Delete a pod
      operationId: deleteAppPod
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: App or pod not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "204":
          description: Deleted successfully

  /app/{appId}/file:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: volumeClaimName
        in: query
        description: The name of the PersistentVolumeClaim to lookup. The corresponding PersistentVolume will be mounted.
        required: true
        schema:
          type: string
      - name: path
        in: query
        required: true
        schema:
          type: string
    get:
      tags: [app]
      description: Get a file in an app's persistent volume
      operationId: getAppFile
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: App or file not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "200":
          description: Success
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    description: A list of directory entries
                    properties:
                      type:
                        type: string
                        enum: [directory]
                      files:
                        type: array
                        items:
                          type: object
                          properties:
                            name:
                              description: The file's base name, including its extension
                              type: string
                            type:
                              description: The file's MIME type, or null if unknown or the file is a directory
                              type: string
                              nullable: true
                            isDirectory:
                              type: boolean
                          required: [name, type, isDirectory]
                  - type: object
                    description: Information about a file
                    properties:
                      type:
                        type: string
                        enum: [file]
                      fileType:
                        type: string
                        description: The file's MIME type
                      name:
                        type: string
                        description: The file's name, including its extension
                      modifiedAt:
                        type: string
                        format: date-time
                      createdAt:
                        type: string
                        format: date-time
                      size:
                        type: number
                        description: The size of the file in bytes
    post:
      tags: [app]
      description: Create a new file (or update an existing file) in an app's persistent volume
      operationId: writeAppFile
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [file, directory]
                files:
                  type: string
                  format: binary
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: App or parent directory not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "201":
          description: Success
    delete:
      tags: [app]
      description: Delete a file in an app's persistent volume
      operationId: deleteAppFile
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "204":
          description: The file was deleted successfully

  /app/{appId}/file/download:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: volumeClaimName
        in: query
        description: The name of the PersistentVolumeClaim to lookup. The corresponding PersistentVolume will be mounted.
        required: true
        schema:
          type: string
      - name: path
        in: query
        required: true
        schema:
          type: string
    get:
      tags: [app]
      description: Download a file in an app's persistent volume
      operationId: downloadAppFile
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: App or file not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "200":
          description: Success
          content:
            "application/octet-stream":
              schema:
                type: string
                description: The full raw content of the file

  /app/{appId}/deployments:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: List an app's recent deployments
      operationId: listDeployments
      parameters:
        - in: query
          name: page
          schema:
            type: integer
          description: Which "page" of deployments to list from.
        - in: query
          name: length
          schema:
            type: integer
          description: How many deployments to return per page.
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DeploymentEntry"
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "404":
          description: Not found

  /app/{appId}/deployments/{deploymentId}/logs:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's recent logs
      operationId: getAppLogs
      parameters:
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/LogType"
      responses:
        "404":
          description: App not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "200":
          description: Success
          content:
            text/event-stream:
              schema:
                description: A server-sent events (SSE) response. Each event will follow the format in '#/components/schemas/LogLine'.
                type: string
  /logs/ingest:
    post:
      operationId: ingestLogs
      parameters:
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [type, lines, deploymentId, hostname]
              properties:
                type:
                  type: string
                  description: Whether the log is from a build or a running application
                  enum: [build, runtime]
                lines:
                  type: array
                  description: The log lines to ingest
                  items:
                    type: object
                    required: [content, stream, timestamp]
                    properties:
                      content:
                        description: The text content of the log line
                        type: string
                      stream:
                        description: The name of the stream that this log line came from
                        type: string
                        enum: [stdout, stderr]
                      timestamp:
                        description: The Unix timestamp (in milliseconds) that this log line was produced
                        type: number
                        format: int64
                deploymentId:
                  description: The ID of the deployment
                  type: number
                  format: int64
                hostname:
                  description: The hostname of the pod that produced the log line, which should equal the pod name
                  type: string
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "403":
          description: Invalid credentials
        "422":
          description: Unexpected authentication type (expected Basic) or log type (expected build or runtime)
        "500":
          description: Internal server error

  /app/{appId}/deployments/{deploymentId}:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's deployment by its ID
      operationId: getDeployment
      responses:
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "404":
          description: Deployment not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deployment"

  /app/subdomain:
    description: Checks if a subdomain is available for use.
    get:
      operationId: isSubdomainAvailable
      parameters:
        - name: subdomain
          in: query
          description: The subdomain to check.
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                required: [available]
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /deployment/update:
    description: Updates a deployment's status. Meant to be called from a build job.
    post:
      operationId: updateDeployment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                secret:
                  type: string
                status:
                  type: string
      responses:
        "200":
          description: Success
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: No secret provided
        "404":
          description: Deployment not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /templates:
    get:
      description: Get a list of template applications.
      operationId: getTemplates
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    displayName:
                      type: string
                    url:
                      type: string
                      format: uri
                    description:
                      type: string
                    port:
                      type: string
                    builder:
                      type: string
                      enum: [dockerfile, railpack]
                    dockerfilePath:
                      type: string
                    subdomain:
                      type: string
                    env:
                      $ref: "#/components/schemas/Envs"
                    mounts:
                      type: array
                      items:
                        $ref: "#/components/schemas/Mount"
                  required:
                    - displayName
                    - url
                    - description
                    - port
                    - builder
                    - subdomain
                    - env
                    - mounts
components:
  schemas:
    UserOrg:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        permissionLevel:
          type: string
          enum: [OWNER, USER]
        githubConnected:
          type: boolean
      required:
        - id
        - name
        - permissionLevel
        - githubConnected
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        name:
          type: string
        orgs:
          type: array
          items:
            $ref: "#/components/schemas/UserOrg"
        projects:
          type: array
          items:
            $ref: "#/components/schemas/RancherProject"
        unassignedInstallations:
          type: array
          items:
            $ref: "#/components/schemas/UnassignedInstallation"
        receivedInvitations:
          type: array
          items:
            $ref: "#/components/schemas/OrgInvitation"
      required:
        - id
        - email
        - name
        - orgs
    UnassignedInstallation:
      type: object
      properties:
        id:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        installationId:
          type: integer
          format: int64
        targetName:
          type: string
        url:
          type: string
          format: uri
      required: [id, userId, installationId, targetName, url]
    Org:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        members:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              name:
                type: string
              email:
                type: string
                format: email
              permissionLevel:
                type: string
                enum: [OWNER, USER]
            required: [id, name, email, permissionLevel]
        appGroups:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              name:
                type: string
              isMono:
                type: boolean
              apps:
                type: array
                items:
                  $ref: "#/components/schemas/AppSummary"
            required: [id, name, apps]
        githubInstallationId:
          type: integer
          format: int64
        outgoingInvitations:
          type: array
          items:
            $ref: "#/components/schemas/OrgInvitation"
      required:
        - id
        - name
        - members
        - appGroups
        - outgoingInvitations
    OrgInvitation:
      type: object
      properties:
        id:
          type: integer
          format: int64
        inviter:
          type: object
          properties:
            name:
              type: string
          required: [name]
        invitee:
          type: object
          properties:
            name:
              type: string
          required: [name]
        org:
          type: object
          properties:
            id:
              type: integer
              format: int64
            name:
              type: string
          required: [id, name]
      required: [id, inviter, invitee, org]
    AppSummary:
      type: object
      properties:
        id:
          type: integer
          format: int64
        displayName:
          type: string
        status:
          type: string
          enum:
            - PENDING
            - QUEUED
            - BUILDING
            - DEPLOYING
            - COMPLETE
            - ERROR
            - STOPPED
            - CANCELLED
        source:
          type: string
          enum: [GIT, IMAGE]
        imageTag:
          type: string
          nullable: true
        repositoryURL:
          type: string
          format: uri
          nullable: true
        branch:
          type: string
          nullable: true
        commitHash:
          type: string
          nullable: true
        link:
          type: string
          format: uri
      required:
        - id
        - displayName
        - status
        - source
        - imageTag
        - repositoryURL
        - branch
        - commitHash
        - link
    App:
      type: object
      properties:
        id:
          type: integer
          format: int64
        orgId:
          type: integer
          format: int64
        projectId:
          type: string
        cdEnabled:
          type: boolean
        appGroup:
          type: object
          properties:
            standalone:
              type: boolean
            name:
              type: string
            id:
              type: integer
              format: int64
            projectId:
              type: string
          required: [standalone, id]
        createdAt:
          type: string
        updatedAt:
          type: string
        name:
          type: string
        displayName:
          type: string
        repositoryId:
          type: number
          format: int64
        repositoryURL:
          type: string
        config:
          $ref: "#/components/schemas/DeploymentConfig"
        subdomain:
          type: string
        activeDeployment:
          type: number
          format: int64
        deploymentCount:
          type: number
          format: int64
      required:
        - id
        - orgId
        - cdEnabled
        - appGroup
        - createdAt
        - updatedAt
        - name
        - displayName
        - config
        - subdomain
        - activeDeployment
        - deploymentCount
    AppUpdate:
      type: object
      properties:
        name:
          type: string
        appGroup:
          oneOf:
            - type: object
              properties:
                type:
                  type: string
                  enum: [standalone]
              required: [type]
            - type: object
              properties:
                type:
                  type: string
                  enum: [create-new]
                name:
                  type: string
              required: [type, name]
            - type: object
              properties:
                type:
                  type: string
                  enum: [add-to]
                id:
                  type: integer
                  format: int64
              required: [type, id]
        projectId:
          type: string
        enableCD:
          type: boolean
        config:
          $ref: "#/components/schemas/DeploymentConfig"
      required:
        - config
    DeploymentConfig:
      type: object
      allOf:
        - oneOf:
            - $ref: "#/components/schemas/GitDeploymentOptions"
            - $ref: "#/components/schemas/ImageDeploymentOptions"
        - $ref: "#/components/schemas/KnownDeploymentOptions"
    KnownDeploymentOptions:
      type: object
      properties:
        # Deployment options
        port:
          type: integer
          format: int64
        replicas:
          type: integer
          format: int64
        env:
          $ref: "#/components/schemas/Envs"
        mounts:
          type: array
          items:
            $ref: "#/components/schemas/Mount"
        collectLogs:
          description: Whether to use the log-shipper wrapper process to collect logs and send them to AnvilOps. When set to false, this wrapper is disabled, so historical logs aren't kept. For more details, see log-shipper/README.md.
          type: boolean
        limits:
          type: object
          additionalProperties:
            type: string
        requests:
          type: object
          additionalProperties:
            type: string
      required:
        - port
        - replicas
        - env
        - mounts
        - limits
        - requests
        - collectLogs
    GitDeploymentOptions:
      allOf:
        - type: object
          properties:
            source:
              type: string
              enum: [git]
            # Source options > Git repository
            dockerfilePath:
              type: string
              nullable: true
            rootDir:
              type: string
            repositoryId:
              type: integer
              format: int64
            event:
              type: string
              enum: [push, workflow_run]
            eventId:
              type: integer
              nullable: true
              format: int64
              description: Required when event == "workflow_run"
            branch:
              type: string
            commitHash:
              type: string
            builder:
              type: string
              enum: [dockerfile, railpack]
            imageTag:
              type: string
          required:
            [
              source,
              dockerfilePath,
              rootDir,
              repositoryId,
              event,
              eventId,
              builder,
            ]
    ImageDeploymentOptions:
      properties:
        source:
          type: string
          enum: [image]
        # Source options > OCI image
        imageTag:
          type: string
        # Deployment options
      required: [source, imageTag]
    Mount:
      type: object
      properties:
        path:
          type: string
        amountInMiB:
          type: integer
        volumeClaimName:
          type: string
      required: [path, amountInMiB]
    DeploymentStatus:
      type: string
      enum:
        - PENDING
        - QUEUED
        - BUILDING
        - DEPLOYING
        - COMPLETE
        - ERROR
        - STOPPED
        - CANCELLED
    DeploymentEntry:
      type: object
      properties:
        id:
          type: number
          format: int64
        appId:
          type: number
          format: int64
        repositoryURL:
          type: string
        commitHash:
          type: string
        commitMessage:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        status:
          $ref: "#/components/schemas/DeploymentStatus"
        source:
          type: string
          enum: [GIT, IMAGE]
        imageTag:
          type: string
          nullable: true
      required:
        - id
        - appId
        - commitHash
        - commitMessage
        - createdAt
        - updatedAt
        - status
        - source
        - imageTag
    Deployment:
      type: object
      properties:
        id:
          type: number
          format: int64
        appId:
          type: number
          format: int64
        repositoryURL:
          type: string
        commitHash:
          type: string
        commitMessage:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        status:
          $ref: "#/components/schemas/DeploymentStatus"
        config:
          $ref: "#/components/schemas/DeploymentConfig"
        podStatus:
          type: object
          properties:
            scheduled:
              type: number
            ready:
              type: number
            total:
              type: number
            failed:
              type: number
          required: [scheduled, ready, total, failed]
      required:
        - id
        - appId
        - commitHash
        - commitMessage
        - createdAt
        - updatedAt
        - status
        - config
    LogLine:
      type: object
      properties:
        time:
          type: string
          format: date-time
        log:
          type: string
        type:
          $ref: "#/components/schemas/LogType"
        stream:
          type: string
          enum: [stdout, stderr]
        pod:
          type: string
        id:
          type: number
          format: int64
      required: [id, time, log, type, pod]
    LogType:
      type: string
      enum: [BUILD, RUNTIME]
    NewApp:
      type: object
      allOf:
        - type: object
          properties:
            name:
              type: string
            # Source options
            orgId:
              type: integer
              format: int64
            projectId:
              type: string
            subdomain:
              type: string
              format: hostname
            port:
              type: integer
              format: int64
            env:
              $ref: "#/components/schemas/Envs"
            mounts:
              type: array
              items:
                $ref: "#/components/schemas/Mount"
            cpuCores:
              type: number
            memoryInMiB:
              type: integer
            appGroup:
              oneOf:
                - type: object
                  properties:
                    type:
                      type: string
                      enum: [standalone]
                  required: [type]
                - type: object
                  properties:
                    type:
                      type: string
                      enum: [create-new]
                    name:
                      type: string
                  required: [type, name]
                - type: object
                  properties:
                    type:
                      type: string
                      enum: [add-to]
                    id:
                      type: integer
                      format: int64
                  required: [type, id]
          required:
            - name
            - orgId
            - subdomain
            - port
            - env
            - mounts
            - appGroup
            - cpuCores
            - memoryInMiB
        - oneOf:
            - $ref: "#/components/schemas/GitDeploymentOptions"
            - $ref: "#/components/schemas/ImageDeploymentOptions"
    NewAppWithoutGroupInfo:
      type: object
      allOf:
        - type: object
          properties:
            name:
              type: string
            # Source options
            orgId:
              type: integer
              format: int64
            projectId:
              type: string
            subdomain:
              type: string
              format: hostname
            port:
              type: integer
              format: int64
            env:
              $ref: "#/components/schemas/Envs"
            mounts:
              type: array
              items:
                $ref: "#/components/schemas/Mount"
            cpuCores:
              type: number
            memoryInMiB:
              type: integer
          required:
            - name
            - orgId
            - subdomain
            - port
            - env
            - mounts
            - cpuCores
            - memoryInMiB
        - oneOf:
            - $ref: "#/components/schemas/GitDeploymentOptions"
            - $ref: "#/components/schemas/ImageDeploymentOptions"
    Envs:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
          value:
            type: string
            nullable: true
          isSensitive:
            type: boolean
        required: [name, value, isSensitive]
    ApiError:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        errors: # for validation fail
          type: array
          items:
            type: object
            properties:
              keyword:
                type: string
              instancePath:
                type: string
              schemaPath:
                type: string
              params:
                additionalProperties: true
              propertyName:
                type: string
              message:
                type: string
            required: [keyword, params]
      required:
        - code
        - message
    ContainerState:
      oneOf:
        - type: object
          properties:
            running:
              type: object
              properties:
                startedAt:
                  type: string
                  format: date-time
        - type: object
          properties:
            terminated:
              type: object
              properties:
                containerID:
                  type: string
                exitCode:
                  type: number
                finishedAt:
                  type: string
                  format: date-time
                message:
                  type: string
                reason:
                  type: string
                signal:
                  type: number
                startedAt:
                  type: string
        - type: object
          properties:
            waiting:
              type: object
              properties:
                message:
                  type: string
                reason:
                  type: string
    AppStatus:
      type: object
      properties:
        pods:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              createdAt:
                type: string
              startedAt:
                type: string
              deploymentId:
                type: number
                format: int64
              node:
                type: string
              podScheduled:
                type: boolean
              podReady:
                type: boolean
              image:
                type: string
              containerReady:
                type: boolean
              containerState:
                $ref: "#/components/schemas/ContainerState"
              lastState:
                $ref: "#/components/schemas/ContainerState"
              ip:
                type: string
        statefulSet:
          type: object
          properties:
            readyReplicas:
              type: number
            updatedReplicas:
              type: number
            replicas:
              type: number
            generation:
              type: number
            observedGeneration:
              type: number
            currentRevision:
              type: string
            updateRevision:
              type: string
        events:
          type: array
          items:
            type: object
            properties:
              message:
                type: string
              reason:
                type: string
              count:
                type: number
              firstTimestamp:
                type: string
                format: date-time
              lastTimestamp:
                type: string
                format: date-time
    RancherProject:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
      required: [id, name, description]
