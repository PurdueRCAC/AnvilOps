openapi: 3.1.0
servers:
  - url: /api
info:
  title: AnvilOps API
  description: ""
  version: 0.0.1
tags:
  - name: user
    description: Operations about users
  - name: org
    description: Operations about organizations
  - name: app
    description: Operations about apps
paths:
  /login:
    get:
      tags:
        - user
      description: Log in user
      operationId: auth_loginUser
      responses:
        "302":
          description: Redirect to identity provider
          headers:
            Location:
              content:
                text/plain:
                  schema:
                    type: string
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /oauth_callback:
    get:
      tags:
        - user
      description: Handle callback
      operationId: auth_handleCallback
      responses:
        "302":
          description: Redirect to application
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /logout:
    post:
      tags:
        - user
      description: Logs out current user
      operationId: auth_logoutUser
      responses:
        "200":
          description: Success
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/installation-callback:
    get:
      description: GitHub installation callback URL. Users are redirected here after they install the app. Then, we redrect them back to GitHub to generate a user access token to verify that they have access to the installation that they're requesting to link with their organization.
      operationId: githubInstallCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: installation_id
          in: query
          description: An identifier that allows us to authenticate with the GitHub API as our GitHub App and access the repositories that the person who installed the app has granted us access to.
          required: true
          schema:
            type: integer
            format: int64
        - name: setup_action
          in: query
          description: Should be set to "install".
          schema:
            type: string
      responses:
        "302":
          description: Success (redirecting back to GitHub for user authorization)
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the installation flow)
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/oauth2-callback:
    get:
      description: GitHub user authorization callback URL. Users are redirected here after they sign in with GitHub. This endpoint checks that they have access to the installation ID that they're trying to link to their organization and then saves that info in our DB.
      operationId: githubOAuthCallback
      parameters:
        - name: state
          in: query
          description: The content that we provided in the `state` query parameter when redirecting to GitHub. Used to link the installation ID to the correct organization.
          required: true
          schema:
            type: string
        - name: code
          in: query
          description: A code that we exchange with GitHub for a user access token.
          required: true
          schema:
            type: string
      responses:
        "302":
          description: Success (redirecting back to the frontend)
        "401":
          description: User IDs don't match (the user signed in to a new account in the middle of the authorization flow)
        "403":
          description: Forbidden (invalid state or code)
        "500":
          description: Unknown error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /github/webhook:
    post:
      description: GitHub App webhooks (see https://docs.github.com/en/apps/creating-github-apps/writing-code-for-a-github-app/building-a-github-app-that-responds-to-webhook-events) for more info
      operationId: githubWebhook
      parameters:
        # Taken from https://raw.githubusercontent.com/github/rest-api-description/refs/heads/main/descriptions/ghes-3.16/ghes-3.16.yaml under /x-webhooks/push/post/parameters
        - name: User-Agent
          in: header
          example: GitHub-Hookshot/123abc
          schema:
            type: string
        - name: X-Github-Hook-Id
          in: header
          example: 12312312
          schema:
            type: string
        - name: X-Github-Event
          in: header
          example: issues
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Id
          in: header
          example: 123123
          schema:
            type: string
        - name: X-Github-Hook-Installation-Target-Type
          in: header
          example: repository
          schema:
            type: string
        - name: X-GitHub-Delivery
          in: header
          example: 0b989ba4-242f-11e5-81e1-c7b6966d2516
          schema:
            type: string
        - name: X-Hub-Signature-256
          in: header
          example: sha256=6dcb09b5b57875f334f61aebed695e2e4193db5e
          schema:
            type: string
        - name: X-GitHub-Enterprise-Version
          in: header
          example: 3.1.9
          schema:
            type: string
        - name: X-GitHub-Enterprise-Host
          in: header
          example: ghes.github.com
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-push"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-created"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-installation-deleted"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-renamed"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-transferred"
                - $ref: "./ghes-3.16.yaml#/components/schemas/webhook-repository-deleted"
      responses:
        "200":
          description: Success
        "401":
          description: Signature was not found (X-Hub-Signature-256 header not present)
        "403":
          description: Signature verification failed
        "422":
          description: Unknown webhook event type
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /user/me:
    get:
      tags:
        - user
      description: Returns the current user
      operationId: getUser
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - user
      description: Deletes the current user.
      operationId: deleteUser
      # parameters:
      #   - name: access_token
      #     in: header
      #     required: true
      #     schema:
      #       type: string
      responses:
        "200":
          description: User deleted
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /user/joinOrg:
    post:
      tags:
        - user
      description: Adds the current user to an organization
      operationId: joinOrg
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                inviteCode:
                  type: string
              required:
                - inviteCode
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserOrg"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /org:
    post:
      tags:
        - org
      description: Create an organization
      operationId: createOrg
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
                - name
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserOrg"
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get organization by id
      operationId: getOrgByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - org
      description: Deletes organization by id
      operationId: deleteOrgByID
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/install-github-app:
    get:
      description: Redirect to GitHub to install the GitHub App on the user's organization
      operationId: githubAppInstall
      parameters:
        - name: orgId
          description: The ID of the organization to connect the app installation to.
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "302":
          description: Redirect
        "401":
          description: Unauthorized
        "404":
          description: Organization not found
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/code:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - org
      description: Get invite code for org
      operationId: getInviteCodeByID
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "404":
          description: Not Found
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /org/{orgId}/repos:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: Get the Git repositories that the organization has access to
      operationId: listOrgRepos
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    name:
                      type: string
                    owner:
                      type: string

  /org/{orgId}/repos/{repoId}/branches:
    parameters:
      - name: orgId
        in: path
        description: Id of organization to return
        required: true
        schema:
          type: integer
          format: int64
      - name: repoId
        in: path
        description: GitHub repository ID
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [org]
      description: List the Git branches of a repository
      operationId: listRepoBranches
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  default:
                    type: string
                  branches:
                    type: array
                    items:
                      type: string

  /app:
    post:
      tags:
        - app
      description: Create an app.
      operationId: createApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewApp"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: number
                    format: int64
                    description: The ID of the newly-created app
        "302":
          description: Redirecting to finish GitHub App installation
        "400":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
        "401":
          description: Unauthorized
        "403":
          description: Contact owner to complete GitHub App installation
        "409":
          description: Subdomain is taken
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /app/{appId}:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags:
        - app
      description: Get app detail by id.
      operationId: getAppByID
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    put:
      tags:
        - app
      description: Update the configuration of an app.
      operationId: updateApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AppUpdate"
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "400":
          description: Malformed app
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      tags:
        - app
      description: Delete an app.
      operationId: deleteApp
      responses:
        "200":
          description: Success
        "401":
          description: Unauthorized
        "500":
          description: Unexpected Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /app/{appId}/deployments:
    parameters:
      - name: appId
        in: path
        description: Id of app to return
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: List an app's recent deployments
      operationId: listDeployments
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: number
                      format: int64
                    appId:
                      type: number
                      format: int64
                    commitHash:
                      type: string
                    commitMessage:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
                    status:
                      $ref: "#/components/schemas/DeploymentStatus"
                  required:
                    - id
                    - appId
                    - commitHash
                    - commitMessage
                    - createdAt
                    - updatedAt
                    - status

  /app/{appId}/deployments/{deploymentId}/logs:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's recent logs
      operationId: getAppLogs
      parameters:
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/LogType"
      responses:
        "404":
          description: App not found
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        time:
                          type: string
                          format: date-time
                        log:
                          type: string
                        type:
                          $ref: "#/components/schemas/LogType"
                        id:
                          type: number
                          format: int64
                required: [logs]

  /logs/ingest:
    post:
      operationId: ingestLogs
      parameters:
        - name: type
          in: query
          required: true
          schema:
            type: string
            enum: [build, runtime]
        - name: Authorization
          in: header
          required: true
          schema:
            type: string
        - name: appId
          in: query
          schema:
            type: number
            format: int64
      requestBody:
        content:
          application/jsonl: # jsonl = newline-delimited JSON objects (https://jsonlines.org/)
            schema:
              type: string
      responses:
        "200":
          description: Success
        "400":
          description: Bad request (no app ID specified when it was required)
        "403":
          description: Invalid credentials
        "422":
          description: Unexpected authentication type (expected Basic) or log type (expected build or runtime)
        "500":
          description: Internal server error

  /app/{appId}/deployments/{deploymentId}:
    parameters:
      - name: appId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      - name: deploymentId
        in: path
        required: true
        schema:
          type: integer
          format: int64
    get:
      tags: [app]
      description: Get an app's deployment by its ID
      operationId: getDeployment
      responses:
        "404":
          description: Deployment not found
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: number
                    format: int64
                  appId:
                    type: number
                    format: int64
                  commitHash:
                    type: string
                  commitMessage:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time
                  status:
                    $ref: "#/components/schemas/DeploymentStatus"
                  config:
                    $ref: "#/components/schemas/DeploymentConfig"
                  storageConfig:
                    $ref: "#/components/schemas/Storage"
                  podStatus:
                    type: object
                    properties:
                      scheduled:
                        type: boolean
                      ready:
                        type: boolean
                      phase:
                        type: string
                        enum: [Pending, Running, Succeeded, Failed, Unknown]
                      state:
                        type: string
                      stateReason:
                        type: string
                required:
                  - id
                  - appId
                  - commitHash
                  - commitMessage
                  - createdAt
                  - updatedAt
                  - status
                  - config
                  - storageConfig

  /deployment/update:
    description: Updates a deployment's status. Meant to be called from a build job.
    post:
      operationId: updateDeployment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                secret:
                  type: string
                status:
                  type: string
      responses:
        "200":
          description: Success
        "400":
          description: Bad request
        "401":
          description: No secret provided
        "403":
          description: Invalid secret
components:
  schemas:
    UserOrg:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        permissionLevel:
          type: string
          enum: [OWNER, USER]
        githubConnected:
          type: boolean
      required:
        - id
        - name
        - permissionLevel
        - githubConnected
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        name:
          type: string
        orgs:
          type: array
          items:
            $ref: "#/components/schemas/UserOrg"
      required:
        - id
        - email
        - name
        - orgs

    Org:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        members:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              name:
                type: string
              email:
                type: string
                format: email
              permissionLevel:
                type: string
                enum: [OWNER, USER]
            required: [id, name, email, permissionLevel]
        apps:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
              name:
                type: string
              status:
                type: string
                enum: [PENDING, BUILDING, DEPLOYING, COMPLETE, ERROR, STOPPED]
              repositoryURL:
                type: string
                format: uri
              branch:
                type: string
              commitHash:
                type: string
              link:
                type: string
                format: uri
            required: [id, name, status, repositoryURL, branch]
        githubInstallationId:
          type: integer
          format: int64
      required:
        - id
        - name
        - members
        - apps
    App:
      type: object
      properties:
        id:
          type: integer
          format: int64
        orgId:
          type: integer
          format: int64
        createdAt:
          type: string
        updatedAt:
          type: string
        displayName:
          type: string
        repositoryId:
          type: number
          format: int64
        repositoryURL:
          type: string
        config:
          $ref: "#/components/schemas/DeploymentConfig"
        storage:
          $ref: "#/components/schemas/Storage"
        subdomain:
          type: string
        activeDeployment:
          type: number
          format: int64
      required:
        - id
        - orgId
        - createdAt
        - updatedAt
        - displayName
        - repositoryId
        - repositoryURL
        - config
        - subdomain
        - activeDeployment
    AppUpdate:
      type: object
      properties:
        name:
          type: string
        config:
          $ref: "#/components/schemas/DeploymentConfig"
        storage:
          $ref: "#/components/schemas/Storage"
      required:
        - name
        - config
    DeploymentConfig:
      type: object
      properties:
        port:
          type: integer
          format: int64
        dockerfilePath:
          type: string
        rootDir:
          type: string
        branch:
          type: string
        builder:
          type: string
          enum: [dockerfile, railpack]
        replicas:
          type: integer
          format: int64
        env:
          $ref: "#/components/schemas/Envs"
        secrets:
          $ref: "#/components/schemas/Envs"
      required: [port, dockerfilePath, rootDir, branch, builder, replicas]
    DeploymentStatus:
      type: string
      enum: [PENDING, BUILDING, DEPLOYING, COMPLETE, ERROR, STOPPED]
    LogType:
      type: string
      enum: [SYSTEM, BUILD, RUNTIME]
    NewApp:
      type: object
      properties:
        orgId:
          type: integer
          format: int64
        name:
          type: string
        repositoryId:
          type: number
          format: int64
        subdomain:
          type: string
          format: hostname
        port:
          type: integer
          format: int64
        dockerfilePath:
          type: string
        rootDir:
          type: string
        branch:
          type: string
        builder:
          type: string
          enum: [dockerfile, railpack]
        env:
          $ref: "#/components/schemas/Envs"
        secrets:
          $ref: "#/components/schemas/Envs"
        storage:
          $ref: "#/components/schemas/Storage"
      required:
        - orgId
        - name
        - repositoryId
        - subdomain
        - port
        - rootDir
        - branch
        - builder
    Envs:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
          value:
            type: string
        required: [name, value]
    Storage:
      type: object
      properties:
        image:
          type: string
        replicas:
          type: integer
          format: int64
        amount:
          type: integer
          format: int64
        port:
          type: integer
          format: int64
        mountPath:
          type: string
        env:
          $ref: "#/components/schemas/Envs"
      required:
        - image
        - replicas
        - amount
        - port
        - mountPath
    ApiError:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      required:
        - code
        - message
